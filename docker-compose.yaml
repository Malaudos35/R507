services:
  db:
    container_name: db
    image: mysql:9.5
    ports:
      - "3306:3306"
    environment:
      - TZ=${TZ}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
    volumes:
      - ./db/sql:/docker-entrypoint-initdb.d
      - ./db/my.conf:/etc/mysql/conf.d/my.conf
    networks:
      frontend:
        ipv4_address: 192.168.1.212
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$$MYSQL_ROOT_PASSWORD"]
      interval: 5s
      timeout: 5s
      retries: 10

  app:
    build:
      context: .
      dockerfile: app3.Dockerfile
    ports:
      - "8000:8000"
    networks:
      frontend:
        ipv4_address: 192.168.1.211
    volumes:
      - ./:/app
    environment:
      - DATABASE_URL=${DATABASE_URL}
    depends_on:
      - db
      - linux
      - router
    restart: always

  router:
    image: aguacero7/frr-router:latest
    container_name: router
    hostname: test-router-1
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
      - NET_RAW
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv6.conf.all.forwarding=0
    ports:
      - "3022:22"   # expose SSH for host access if needed
    networks:
      frontend:
        ipv4_address: 192.168.1.252
    # si vous voulez monter une config FRR personnalis√©e
    # volumes:
    #   - frr.conf:/etc/frr/frr.conf

  linux:
    # image: alpine
    build:
      context: .
      dockerfile: alpine.Dockerfile
    container_name: linux
    networks:
      frontend:
        ipv4_address: 192.168.1.253
    ports:
      - "2022:22"  # expose SSH for host access if needed
    command: ["sh", "-c", "apk add --no-cache openssh && /usr/sbin/sshd -D"]  # lancer sshd dans alpine

networks:
  frontend:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.1.0/24
